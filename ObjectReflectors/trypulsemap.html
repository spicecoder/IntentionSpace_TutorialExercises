<!DOCTYPE html>
<html>
<head>
  <title>Exercise 4.2: Pure Pulse Mapping</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      max-width: 1000px; 
      margin: 50px auto;
      padding: 20px;
    }
    .section {
      border: 2px solid #ddd;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
    }
    .kitchen { background-color: #fff3cd; }
    .window { background-color: #e3f2fd; }
    .server { background-color: #d4edda; }
    
    .pulse-box {
      background: white;
      padding: 12px;
      margin: 8px 0;
      border-left: 4px solid #2196F3;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
    }
    
    .pulse-name {
      font-weight: bold;
      color: #1976D2;
    }
    
    .pulse-value {
      color: #333;
      background: #f5f5f5;
      padding: 2px 6px;
      border-radius: 3px;
      margin-left: 8px;
    }
    
    .example-box {
      border: 3px solid;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
    }
    .example-box.wrong { 
      border-color: #f44336; 
      background-color: #ffebee;
    }
    .example-box.right { 
      border-color: #4CAF50; 
      background-color: #e8f5e9;
    }
    
    button {
      background-color: #2196F3;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover { background-color: #1976D2; }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    
    .concept-box {
      background-color: #fff3e0;
      border-left: 4px solid #ff9800;
      padding: 15px;
      margin: 20px 0;
    }
    
    .comparison {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px 0;
    }
    
    .tab-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .tab-button {
      flex: 1;
      padding: 15px;
      border: 2px solid #ddd;
      background: white;
      cursor: pointer;
      border-radius: 8px 8px 0 0;
      font-weight: bold;
    }
    
    .tab-button.active {
      border-bottom: none;
      background: #e3f2fd;
      border-color: #2196F3;
    }
    
    .tab-button.wrong { border-color: #f44336; }
    .tab-button.wrong.active { background: #ffebee; }
    .tab-button.right { border-color: #4CAF50; }
    .tab-button.right.active { background: #e8f5e9; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState } = React;

    // ========================================
    // WRONG APPROACH: Value Transformation
    // ========================================
    class ImpureObject {
      constructor() {
        this.heldIntentions = [];
        this.dishTranslations = {
          'Pasta': 'Fideos',
          'Salad': 'Ensalada',
          'Burger': 'Hamburguesa'
        };
      }

      receive(intention) {
        this.heldIntentions.push(intention);
      }

      // ‚ùå WRONG: Transforms pulse VALUES
      transformValues(pulses) {
        console.log('‚ùå IMPURE: Transforming pulse values...');
        
        return {
          ...pulses,
          dish_name: this.dishTranslations[pulses.dish_name] || pulses.dish_name
        };
      }

      reflect(onReflected) {
        if (this.heldIntentions.length === 0) return null;
        
        const intention = this.heldIntentions[0];
        const transformed = this.transformValues(intention.pulses);
        
        this.heldIntentions = [];
        onReflected({ ...intention, pulses: transformed });
        return transformed;
      }

      getState() {
        return { heldCount: this.heldIntentions.length };
      }
    }

    // ========================================
    // RIGHT APPROACH: Pulse-to-Pulse Mapping
    // ========================================
    class PureObject {
      constructor() {
        this.heldIntentions = [];
      }

      receive(intention) {
        this.heldIntentions.push(intention);
      }

      // ‚úÖ RIGHT: Maps PULSES to PULSES (values unchanged)
      mapPulses(pulses) {
        console.log('‚úÖ PURE: Mapping pulse to pulse...');
        console.log('   Original pulses:', pulses);
        
        // COPY operation: Create new pulse with SAME value
        const mapped = {
          ...pulses,  // Keep originals (immutable!)
          'table_dish': pulses['item_dish'],        // Copy pulse
          'table_customer': pulses['customer_name'], // Copy pulse
          'table_number': pulses['table_num']        // Copy pulse
        };
        
        console.log('   After mapping:', mapped);
        console.log('   Notice: ALL original pulses still present!');
        console.log('   Notice: Values UNCHANGED!');
        
        return mapped;
      }

      // ‚úÖ AGGREGATE: Combine multiple pulses (CSV append)
      aggregatePulses(existingPulses, newPulses) {
        console.log('‚úÖ PURE: Aggregating pulses...');
        
        const tableKey = `table_${newPulses.table_num}_orders`;
        const newLine = `${newPulses.item_dish},${newPulses.customer_name}`;
        
        const existing = existingPulses[tableKey] || '';
        const aggregated = existing ? `${existing}\n${newLine}` : newLine;
        
        console.log('   Appended:', newLine);
        console.log('   Result:', aggregated);
        
        return {
          ...existingPulses,
          [tableKey]: aggregated
        };
      }

      reflect(onReflected, existingAggregated = {}) {
        if (this.heldIntentions.length === 0) return null;
        
        const intention = this.heldIntentions[0];
        let mapped = this.mapPulses(intention.pulses);
        mapped = this.aggregatePulses(existingAggregated, intention.pulses);
        
        this.heldIntentions = [];
        onReflected({ ...intention, pulses: mapped });
        return mapped;
      }

      getState() {
        return { heldCount: this.heldIntentions.length };
      }
    }

    // ========================================
    // UI Component
    // ========================================
    function ComparisonDemo() {
      const [activeTab, setActiveTab] = useState('wrong');
      const [impureObj] = useState(() => new ImpureObject());
      const [pureObj] = useState(() => new PureObject());
      
      const [wrongInput, setWrongInput] = useState({});
      const [wrongOutput, setWrongOutput] = useState({});
      const [rightInput, setRightInput] = useState({});
      const [rightOutput, setRightOutput] = useState({});
      const [aggregated, setAggregated] = useState({});
      const [log, setLog] = useState([]);

      const addLog = (message) => {
        setLog(prev => [...prev, `${new Date().toLocaleTimeString()}: ${message}`]);
      };

      // Wrong approach
      const sendOrderWrong = (dish, customer, table) => {
        const pulses = {
          dish_name: dish,
          customer_name: customer,
          table_num: String(table)
        };

        setWrongInput(pulses);
        impureObj.receive({ intentionId: 'INT_ORDER', pulses });
        addLog(`‚ùå WRONG: Sent order (${dish})`);
      };

      const reflectWrong = () => {
        impureObj.reflect((intention) => {
          setWrongOutput(intention.pulses);
          addLog(`‚ùå Object CHANGED value: ${wrongInput.dish_name} ‚Üí ${intention.pulses.dish_name}`);
        });
      };

      // Right approach
      const sendOrderRight = (dish, customer, table) => {
        const pulses = {
          item_dish: dish,
          customer_name: customer,
          table_num: String(table)
        };

        setRightInput(pulses);
        pureObj.receive({ intentionId: 'INT_ORDER', pulses });
        addLog(`‚úÖ RIGHT: Sent order (${dish})`);
      };

      const reflectRight = () => {
        pureObj.reflect((intention) => {
          setRightOutput(intention.pulses);
          setAggregated(intention.pulses);
          addLog(`‚úÖ Object mapped pulses (values unchanged)`);
        }, aggregated);
      };

      const renderPulses = (pulses, highlight = []) => {
        return Object.entries(pulses).map(([key, value]) => (
          <div 
            key={key} 
            className="pulse-box"
            style={{
              borderColor: highlight.includes(key) ? '#4CAF50' : '#2196F3',
              backgroundColor: highlight.includes(key) ? '#e8f5e9' : 'white'
            }}
          >
            <span className="pulse-name">{key}:</span>
            <span className="pulse-value">{value}</span>
          </div>
        ));
      };

      return (
        <div>
          <h1>ü™û Exercise 4.2: Pure Pulse Mapping</h1>
          
          <div className="concept-box">
            <strong>‚ö†Ô∏è Critical Rule:</strong> Objects map <strong>PULSES to PULSES</strong>, NOT values to values!
            <ul>
              <li>‚úÖ Original pulses remain <strong>immutable</strong></li>
              <li>‚úÖ Create <strong>new pulse names</strong> with same values</li>
              <li>‚ùå NEVER change pulse response values</li>
              <li>‚ùå Value transformation = computation (belongs in DN)</li>
            </ul>
          </div>

          <div className="tab-buttons">
            <button 
              className={`tab-button wrong ${activeTab === 'wrong' ? 'active' : ''}`}
              onClick={() => setActiveTab('wrong')}
            >
              ‚ùå WRONG: Value Transformation
            </button>
            <button 
              className={`tab-button right ${activeTab === 'right' ? 'active' : ''}`}
              onClick={() => setActiveTab('right')}
            >
              ‚úÖ RIGHT: Pulse-to-Pulse Mapping
            </button>
          </div>

          {activeTab === 'wrong' && (
            <div className="example-box wrong">
              <h2>‚ùå Anti-Pattern: Object Changes Pulse Values</h2>
              <p><strong>Why this is wrong:</strong> Object transforms "Pasta" ‚Üí "Fideos". This is computation!</p>

              <div className="section kitchen">
                <h3>Kitchen (Input)</h3>
                <button onClick={() => sendOrderWrong('Pasta', 'Alice', 3)}>
                  Send Pasta Order
                </button>
                <button onClick={() => sendOrderWrong('Salad', 'Bob', 3)}>
                  Send Salad Order
                </button>
                
                {Object.keys(wrongInput).length > 0 && (
                  <div style={{marginTop: '15px'}}>
                    <strong>Input Pulses:</strong>
                    {renderPulses(wrongInput)}
                  </div>
                )}
              </div>

              <div className="section window">
                <h3>Object (Transforms Values)</h3>
                <button onClick={reflectWrong} disabled={impureObj.getState().heldCount === 0}>
                  üîÑ Transform & Reflect
                </button>
                <div style={{color: '#f44336', marginTop: '10px', fontWeight: 'bold'}}>
                  ‚ö†Ô∏è This Object CHANGES the value!
                </div>
              </div>

              <div className="section server">
                <h3>Server (Output)</h3>
                {Object.keys(wrongOutput).length > 0 ? (
                  <div>
                    <strong>Output Pulses:</strong>
                    {renderPulses(wrongOutput)}
                    <div style={{
                      background: '#ffebee',
                      padding: '15px',
                      borderRadius: '4px',
                      marginTop: '15px',
                      border: '2px solid #f44336'
                    }}>
                      <strong style={{color: '#f44336'}}>‚ùå Problem:</strong>
                      <ul>
                        <li>Value CHANGED: "Pasta" became "Fideos"</li>
                        <li>Original pulse value LOST</li>
                        <li>Object performed COMPUTATION (lookup)</li>
                        <li>Breaks immutability principle</li>
                        <li>Where does it stop? Format dates? Calculate totals?</li>
                      </ul>
                    </div>
                  </div>
                ) : (
                  <p style={{color: '#666'}}>Waiting for reflection...</p>
                )}
              </div>
            </div>
          )}

          {activeTab === 'right' && (
            <div className="example-box right">
              <h2>‚úÖ Correct Pattern: Object Maps Pulse Names Only</h2>
              <p><strong>Why this is right:</strong> Object creates NEW pulses with SAME values. Immutable!</p>

              <div className="section kitchen">
                <h3>Kitchen (Input)</h3>
                <button onClick={() => sendOrderRight('Pasta', 'Alice', 3)}>
                  Send Pasta Order
                </button>
                <button onClick={() => sendOrderRight('Salad', 'Bob', 3)}>
                  Send Salad Order
                </button>
                <button onClick={() => sendOrderRight('Burger', 'Carol', 5)}>
                  Send Burger Order
                </button>
                
                {Object.keys(rightInput).length > 0 && (
                  <div style={{marginTop: '15px'}}>
                    <strong>Input Pulses:</strong>
                    {renderPulses(rightInput)}
                  </div>
                )}
              </div>

              <div className="section window">
                <h3>Object (Maps Pulses)</h3>
                <button onClick={reflectRight} disabled={pureObj.getState().heldCount === 0}>
                  üîÑ Map Pulses & Reflect
                </button>
                <div style={{
                  background: '#e8f5e9',
                  padding: '10px',
                  borderRadius: '4px',
                  marginTop: '10px',
                  border: '2px solid #4CAF50'
                }}>
                  <strong style={{color: '#4CAF50'}}>‚úÖ Pure Operations:</strong>
                  <ol style={{margin: '10px 0', paddingLeft: '20px'}}>
                    <li>COPY: item_dish ‚Üí table_dish</li>
                    <li>COPY: customer_name ‚Üí table_customer</li>
                    <li>COPY: table_num ‚Üí table_number</li>
                    <li>AGGREGATE: Append to table_N_orders (CSV)</li>
                  </ol>
                </div>
              </div>

              <div className="section server">
                <h3>Server (Output)</h3>
                {Object.keys(rightOutput).length > 0 ? (
                  <div>
                    <strong>Output Pulses:</strong>
                    {renderPulses(rightOutput, ['table_dish', 'table_customer', 'table_number'])}
                    <div style={{
                      background: '#e8f5e9',
                      padding: '15px',
                      borderRadius: '4px',
                      marginTop: '15px',
                      border: '2px solid #4CAF50'
                    }}>
                      <strong style={{color: '#4CAF50'}}>‚úÖ Correct:</strong>
                      <ul>
                        <li>ALL original pulses still present (immutable)</li>
                        <li>NEW pulses created (highlighted in green)</li>
                        <li>Values UNCHANGED: "Pasta" is still "Pasta"</li>
                        <li>Object did NO computation</li>
                        <li>Aggregated orders in CSV format (simple append)</li>
                      </ul>
                    </div>
                  </div>
                ) : (
                  <p style={{color: '#666'}}>Waiting for reflection...</p>
                )}
              </div>
            </div>
          )}

          <div className="section">
            <h2>üìã Event Log</h2>
            <div style={{
              maxHeight: '200px',
              overflowY: 'auto',
              fontFamily: 'monospace',
              fontSize: '12px',
              background: '#f8f9fa',
              padding: '10px',
              borderRadius: '4px'
            }}>
              {log.length === 0 ? (
                <div style={{color: '#999'}}>No events yet...</div>
              ) : (
                log.map((entry, idx) => (
                  <div key={idx}>{entry}</div>
                ))
              )}
            </div>
            <p style={{fontSize: '12px', color: '#666', marginTop: '10px'}}>
              üí° Open browser console (F12) to see detailed operation logs
            </p>
          </div>
        </div>
      );
    }

    ReactDOM.render(<ComparisonDemo />, document.getElementById('root'));
  </script>
</body>
</html>